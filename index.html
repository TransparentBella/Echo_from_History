<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš”ï¸ å†å²å¹³è¡Œå¯¹è¯ Agent</title>
    <style>
        /* å…¨å±€åŸºç¡€è®¾ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }

        /* 1. BODY: ç†æ€§ã€æ²‰ç¨³çš„èƒŒæ™¯ */
        body {
            background-color: #F8F8F8;
            color: #333;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
        }

        .container {
            max-width: 1400px; /* å¢å¤§å®¹å™¨ä»¥å®¹çº³ä¸‰æ  */
            width: 95%;
            height: 90vh; 
            background-color: white; 
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border-radius: 15px;
            overflow: hidden;
            display: flex; 
            opacity: 0; 
            transition: opacity 0.8s ease;
        }

        /* 2. å·¦ä¾§è®¾ç½®é¢æ¿ (å›ºå®šå®½åº¦) */
        #settings-panel {
            flex: 0 0 320px; /* å¢å¤§å·¦ä¾§å®½åº¦ï¼Œå®¹çº³ä¸¤ä¸ªè§’è‰²è®¾ç½® */
            padding: 20px;
            overflow-y: auto;
            background-color: #EFEFEF; 
            border-right: 1px solid #DDD;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* è§’è‰²å¡ç‰‡æ ·å¼ */
        .character-card {
            padding: 15px;
            border-radius: 10px;
            background-color: #FFF;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid #DDD;
        }
        
        .char-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #AAA;
            margin: 0 auto 10px;
            font-size: 2rem;
            line-height: 60px;
            color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        /* 3. ä¸­é—´å¯¹è¯åŒº (å æ®æœ€å¤§ç©ºé—´) */
        .dialogue-area {
            flex: 1; 
            display: flex;
            flex-direction: column;
            background-color: #FAFAFA;
            border-right: 1px solid #DDD;
        }

        /* æ–°å¢ï¼šè¾©è®ºä¸»é¢˜å®¹å™¨æ ·å¼ */
        #debate-theme-container {
            padding: 10px 20px;
            text-align: center;
            border-bottom: 1px solid #EAEAEA;
            background-color: #FFF;
        }
        #debate-theme-container label {
            font-weight: 600;
            color: #4682B4; /* çªå‡ºé¢œè‰² */
        }

        .chat-history {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .chat-input {
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            background-color: #FFF;
        }

        /* 4. å³ä¾§æ§åˆ¶å° (å›ºå®šå®½åº¦) */
        #control-panel {
            flex: 0 0 280px; /* æ§åˆ¶å°å®½åº¦ */
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #E6E6E6;
        }


        /* 5. å¯¹è¯æ°”æ³¡æ ·å¼ (çœç•¥æœªä¿®æ”¹éƒ¨åˆ†) */
        .message {
            display: flex;
            margin-bottom: 15px;
        }

        .message.left .bubble {
            background-color: #DDEEFF; 
            color: #333;
            border-radius: 15px 15px 15px 0;
            margin-right: auto;
        }
        
        .message.right {
            justify-content: flex-end;
        }
        .message.right .bubble {
            background-color: #E6E6FA; 
            color: #333;
            border-radius: 15px 15px 0 15px;
            margin-left: auto;
        }

        .bubble {
            max-width: 60%;
            padding: 12px 18px;
            line-height: 1.6;
            font-size: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        /* 6. é€šç”¨å…ƒç´  (çœç•¥æœªä¿®æ”¹éƒ¨åˆ†) */
        h1, h2, h3 {
            color: #4682B4;
        }
        
        label {
            font-weight: 600;
            color: #555;
            margin-top: 5px;
        }

        input[type="text"], select {
            width: 100%;
            padding: 8px;
            border: 1px solid #DDD;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .btn {
            background: linear-gradient(to right, #4682B4, #6495ED);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn:disabled {
            background: #AAA;
            cursor: not-allowed;
        }
        
        /* å“åº”å¼è°ƒæ•´ (ç®€åŒ–ä¸ºå‚ç›´å †å ) (æœªä¿®æ”¹) */
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
                height: auto;
                min-height: 90vh;
            }
            #settings-panel, #control-panel {
                flex: 0 0 auto;
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #DDD;
            }
            #settings-panel {
                order: 1;
            }
            .dialogue-area {
                order: 2;
                height: 60vh; /* ç¡®ä¿å¯¹è¯åŒºä»æœ‰ä¸€å®šé«˜åº¦ */
            }
            #control-panel {
                order: 3;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="main-container" style="opacity: 0;">
        
        <div id="settings-panel">
            <h2 style="color: #4682B4;">âœï¸ è§’è‰²è®¾å®šå°</h2>

            <div class="character-card">
                <h3 style="margin-bottom: 10px;">è§’è‰² A</h3>
                <div class="char-avatar" id="avatar-a">ğŸ‘´</div>
                <label for="name-a">åç§°:</label>
                <input type="text" id="name-a" value="å­”å­" placeholder="äººç‰©åç§°">
                <label for="desc-a">èº«ä»½/æ ¸å¿ƒå“²å­¦:</label>
                <input type="text" id="desc-a" value="å„’å®¶åˆ›å§‹äºº, é‡ä»ä¹‰å’Œç¤¼æ²»" placeholder="ç®€çŸ­èº«ä»½æè¿°">
                <label for="persona-a">æ€§æ ¼/é£æ ¼:</label>
                <input type="text" id="persona-a" value="æ¸©æ–‡å°”é›…, é€»è¾‘ä¸¥å¯†, å¼•ç”¨ç»å…¸" placeholder="ä¾‹å¦‚ï¼šæ¿€è¿›ï¼Œå¹½é»˜ï¼Œç†æ€§">
            </div>

            <div class="character-card">
                <h3 style="margin-bottom: 10px;">è§’è‰² B</h3>
                <div class="char-avatar" id="avatar-b" style="background-color: #555;">ğŸ¤–</div>
                <label for="name-b">åç§°:</label>
                <input type="text" id="name-b" value="é©¬æ–¯å…‹" placeholder="äººç‰©åç§°">
                <label for="desc-b">èº«ä»½/æ ¸å¿ƒå“²å­¦:</label>
                <input type="text" id="desc-b" value="ç§‘æŠ€ä¼ä¸šå®¶, å…³æ³¨ç«æ˜Ÿæ®–æ°‘ä¸AI" placeholder="ç®€çŸ­èº«ä»½æè¿°">
                <label for="persona-b">æ€§æ ¼/é£æ ¼:</label>
                <input type="text" id="persona-b" value="å¤§èƒ†æ¿€è¿›, è¯­é€Ÿå¿«, ä¾§é‡æœªæ¥ä¸»ä¹‰" placeholder="ä¾‹å¦‚ï¼šæ¿€è¿›ï¼Œå¹½é»˜ï¼Œç†æ€§">
            </div>
            
        </div>

        <div class="dialogue-area">
            <h1 style="padding: 15px; text-align: center; font-size: 1.8rem; border-bottom: 1px solid #DDD;">âš”ï¸ å†å²å¹³è¡Œå¯¹è¯</h1>
            
            <div id="debate-theme-container">
                <label for="theme">è¾©è®ºä¸»é¢˜ï¼š</label>
                <input type="text" id="theme" placeholder="ä¾‹å¦‚ï¼šæŠ€æœ¯å‘å±•ä¸äººç±»è‡ªç”±çš„å…³ç³»">
            </div>
            
            <div class="chat-history" id="chat-history">
                <p style="text-align: center; color: #888; padding: 20px;">è¯·åœ¨å·¦ä¾§è®¾å®šäººç‰©ï¼Œè®¾å®šä¸»é¢˜ï¼Œç„¶ååœ¨å³ä¾§ç‚¹å‡»â€œå¼€å§‹è¾©è®ºâ€ï¼</p>
            </div>
            
            <div class="chat-input">
                <input type="text" id="user-input" placeholder="è¾“å…¥æ‚¨çš„è§‚ç‚¹æˆ–æŒ‘æˆ˜ (å¯é€‰)..." disabled>
                <button class="btn" id="send-btn" disabled>ä»‹å…¥</button>
            </div>
        </div>

        <div id="control-panel">
            <h2 style="color: #4682B4;">ğŸ•¹ï¸ æµç¨‹æ§åˆ¶å°</h2>
            
            <label for="turns">è‡ªåŠ¨è¾©è®ºè½®æ•°ï¼š</label>
            <select id="turns">
                <option value="1">1 è½® (åŒæ–¹å„å‘è¨€ä¸€æ¬¡)</option>
                <option value="2">2 è½®</option>
                <option value="3" selected>3 è½® (é»˜è®¤)</option>
                <option value="4">4 è½®</option>
            </select>
            
            <button class="btn" id="start-btn" style="background: #28a745; margin-top: 20px;">ğŸš€ å¼€å§‹è¾©è®º</button>
            <button class="btn" id="continue-btn" disabled>â¡ï¸ è‡ªåŠ¨è¿›è¡Œä¸‹ä¸€è½®</button>
            <button class="btn" id="reset-scene" style="background: #dc3545;">ğŸ—‘ï¸ é‡ç½®åœºæ™¯</button>

            <div class="error-message" id="error-message" style="color: #dc3545; font-size: 0.9rem; margin-top: 10px; display: none;"></div>
        </div>
        
    </div>

    <script>
        // APIå¯†é’¥å ä½ç¬¦
        const API_KEY = 'dc8c102cf12b429087166045e70a6a02.mq2zID9rW1Anthp0'; 

        document.addEventListener('DOMContentLoaded', function() {
            // --- UI å…ƒç´ è·å– (æ–°å¢ persona) ---
            const mainContainer = document.getElementById('main-container');
            const chatHistory = document.getElementById('chat-history');
            
            const nameA = document.getElementById('name-a');
            const descA = document.getElementById('desc-a');
            const personaA = document.getElementById('persona-a'); // æ–°å¢
            
            const nameB = document.getElementById('name-b');
            const descB = document.getElementById('desc-b');
            const personaB = document.getElementById('persona-b'); // æ–°å¢
            
            const themeInput = document.getElementById('theme'); // **ä¿ç•™åœ¨ä¸­é—´åŒºåŸŸ**
            const turnsSelect = document.getElementById('turns');
            const startBtn = document.getElementById('start-btn');
            const continueBtn = document.getElementById('continue-btn');
            const resetBtn = document.getElementById('reset-scene');
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const errorMessage = document.getElementById('error-message');

            // --- çŠ¶æ€ç®¡ç† (ä¿æŒä¸å˜) ---
            let dialogueHistory = [];
            let currentTurn = 0;
            let totalTurns = 3;
            let currentSpeaker = 'A'; // 'A' æˆ– 'B'

            // **åˆå§‹åŒ–æ˜¾ç¤º**
            mainContainer.style.opacity = '1';
            
            // --- è¾…åŠ©å‡½æ•° ---
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                setTimeout(() => { errorMessage.style.display = 'none'; }, 7000);
            }
            
            // æ¸²æŸ“å¯¹è¯æ°”æ³¡ (ä¿æŒä¸å˜)
            function renderMessage(speaker, content) {
                const messageDiv = document.createElement('div');
                
                let position;
                let charName;
                if (speaker === 'A' || speaker === nameA.value) {
                    position = 'left';
                    charName = nameA.value;
                } else if (speaker === 'B' || speaker === nameB.value) {
                    position = 'right';
                    charName = nameB.value;
                } else {
                    // è£åˆ¤å‘è¨€
                    position = 'center'; 
                    charName = 'è£åˆ¤';
                }
                
                messageDiv.classList.add('message', position);
                messageDiv.innerHTML = `
                    <div class="bubble">
                        <strong>${charName}:</strong><br>
                        ${content.replace(/\n/g, '<br>')}
                    </div>
                `;
                chatHistory.appendChild(messageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
            
            // --- æ ¸å¿ƒå‡½æ•°ï¼šAgent API è°ƒç”¨ (ä¿æŒä¸å˜) ---
            async function callGLMAPI(prompt) {
                // ... (API è°ƒç”¨é€»è¾‘ï¼Œä¿æŒä¸å˜) ...
                if (API_KEY != 'dc8c102cf12b429087166045e70a6a02.mq2zID9rW1Anthp0') {
                    showError('è­¦å‘Šï¼šAPI å¯†é’¥æœªè®¾ç½®ï¼Œè¯·æ›¿æ¢ä¸ºæ‚¨çš„æ™ºè°±å¯†é’¥ã€‚');
                    throw new Error('API å¯†é’¥æœªè®¾ç½®ã€‚');
                }
                
                const messages = [{ role: "user", content: prompt }];
                const requestBody = {
                    model: "glm-4",
                    messages: messages,
                    temperature: 0.8,
                    max_tokens: 1500 
                };
                
                const response = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorData.detail || errorData.message}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content.trim();
            }

            // --- æ ¸å¿ƒé€»è¾‘ï¼šç”Ÿæˆä¸‹ä¸€è½®å‘è¨€ (æ›´æ–° Prompt æ¨¡æ¿ä»¥åŒ…å« Persona) ---
            async function generateNextTurn(isAuto = true, userChallenge = '') {
                // ç¡®ä¿åªæœ‰åœ¨è‡ªåŠ¨è½®æ¬¡ä¸”æœªç»“æŸæ—¶ï¼Œæˆ–è€…ç”¨æˆ·ä»‹å…¥æ—¶æ‰ç»§ç»­
                if (isAuto && currentTurn >= totalTurns && dialogueHistory.length > 0 && !userChallenge) {
                    continueBtn.disabled = true;
                    showError('è‡ªåŠ¨è¾©è®ºè½®æ¬¡å·²ç»“æŸã€‚è¯·ç‚¹å‡»â€œé‡ç½®åœºæ™¯â€å¼€å§‹æ–°çš„è¾©è®ºï¼Œæˆ–ç‚¹å‡»â€œä»‹å…¥â€ç»§ç»­è‡ªç”±è¾©è®ºã€‚');
                    return;
                }
                
                // é”å®šæŒ‰é’®
                startBtn.disabled = true;
                continueBtn.disabled = true;
                sendBtn.disabled = true;
                userInput.disabled = true;
                
                const theme = themeInput.value.trim();
                const charA = { name: nameA.value.trim(), desc: descA.value.trim(), persona: personaA.value.trim() };
                const charB = { name: nameB.value.trim(), desc: descB.value.trim(), persona: personaB.value.trim() };
                
                try {
                    // ç¡®å®šå‘è¨€äºº
                    const speaker = (currentSpeaker === 'A') ? charA : charB;
                    const listener = (currentSpeaker === 'A') ? charB : charA;

                    // æ„é€ æ–°çš„ï¼ŒåŒ…å« persona çš„ Prompt
                    let prompt = '';
                    const personaInstruction = `ä½ çš„è¯­è¨€é£æ ¼å’Œæ€åº¦å¿…é¡»ä¸¥æ ¼éµå¾ªä½ çš„æ€§æ ¼è®¾å®šï¼šã€${speaker.persona}ã€‘ã€‚`;

                    if (dialogueHistory.length === 0) {
                        // ç¬¬ä¸€è½®å‘è¨€
                        prompt = `ç°åœ¨å¼€å§‹ä¸€åœºå…³äºã€${theme}ã€‘çš„è¾©è®ºã€‚ä½ æ˜¯ã€${speaker.name}ã€‘ï¼Œèº«ä»½æ˜¯ï¼š${speaker.desc}ã€‚${personaInstruction} è¯·ä½ é¦–å…ˆå‘è¨€ï¼Œå¯¹ä¸»é¢˜æå‡ºä½ çš„æ ¸å¿ƒè§‚ç‚¹ã€‚ä¿æŒå‘è¨€åœ¨150å­—ä»¥å†…ã€‚ä½ çš„å‘è¨€å¿…é¡»ä¸¥æ ¼éµå¾ªè‡ªå·±çš„èº«ä»½å’Œç‰¹ç‚¹ï¼Œä»¥æœ¬äººçš„å£å»å‘è¨€ï¼Œå‘è¨€ä¸å¾—åŒ…å«ä»»ä½•ä¸å‘è¨€å†…å®¹æ— å…³çš„å†…å®¹`;
                    } else if (userChallenge) {
                         // ç”¨æˆ·ä»‹å…¥åçš„å‘è¨€
                        prompt = `å½“å‰è¾©è®ºä¸»é¢˜æ˜¯ã€${theme}ã€‘ã€‚ä½ æ˜¯ã€${speaker.name}ã€‘ï¼Œèº«ä»½æ˜¯ï¼š${speaker.desc}ã€‚${personaInstruction} è£åˆ¤ï¼ˆç”¨æˆ·ï¼‰åˆšåˆšä»‹å…¥å¹¶æå‡ºäº†ä»¥ä¸‹æŒ‘æˆ˜ï¼šâ€œ${userChallenge}â€ã€‚è¯·ä½ é’ˆå¯¹è¿™ä¸ªæŒ‘æˆ˜ï¼Œç»“åˆä½ æœ€è¿‘çš„å‘è¨€å’Œå¯¹æ–¹çš„è§‚ç‚¹ï¼Œè¿›è¡Œå›åº”ã€‚ä¿æŒå‘è¨€åœ¨150å­—ä»¥å†…ã€‚ä½ çš„å‘è¨€å¿…é¡»ä¸¥æ ¼éµå¾ªè‡ªå·±çš„èº«ä»½å’Œç‰¹ç‚¹ï¼Œä»¥æœ¬äººçš„å£å»å‘è¨€ï¼Œå‘è¨€ä¸å¾—åŒ…å«ä»»ä½•ä¸å‘è¨€å†…å®¹æ— å…³çš„å†…å®¹ã€‚æœ€è¿‘çš„å¯¹è¯è®°å½•ï¼š\n${dialogueHistory.map(d => `${d.speaker}: ${d.content}`).slice(-4).join('\n')}`;
                    } else {
                        // æ­£å¸¸è½®æ¢å‘è¨€
                        prompt = `å½“å‰è¾©è®ºä¸»é¢˜æ˜¯ã€${theme}ã€‘ã€‚ä½ æ˜¯ã€${speaker.name}ã€‘ï¼Œèº«ä»½æ˜¯ï¼š${speaker.desc}ã€‚${personaInstruction} è¯·ä½ é’ˆå¯¹ã€${listener.name}ã€‘çš„æœ€æ–°è§‚ç‚¹è¿›è¡Œåé©³æˆ–å›åº”ã€‚ä¿æŒå‘è¨€åœ¨150å­—ä»¥å†…ã€‚ä½ çš„å‘è¨€å¿…é¡»ä¸¥æ ¼éµå¾ªè‡ªå·±çš„èº«ä»½å’Œç‰¹ç‚¹ï¼Œä»¥æœ¬äººçš„å£å»å‘è¨€ï¼Œå‘è¨€ä¸å¾—åŒ…å«ä»»ä½•ä¸å‘è¨€å†…å®¹æ— å…³çš„å†…å®¹ã€‚æœ€è¿‘çš„å¯¹è¯è®°å½•ï¼š\n${dialogueHistory.map(d => `${d.speaker}: ${d.content}`).slice(-4).join('\n')}`;
                    }

                    // 1. è°ƒç”¨ Agent
                    const response = await callGLMAPI(prompt);
                    
                    // 2. æ¸²æŸ“å’Œè®°å½•
                    renderMessage(speaker.name, response);
                    dialogueHistory.push({ speaker: speaker.name, content: response });
                    
                    // 3. æ›´æ–°çŠ¶æ€
                    currentSpeaker = (currentSpeaker === 'A') ? 'B' : 'A'; // åˆ‡æ¢å‘è¨€äºº
                    
                    // å¦‚æœæ˜¯è‡ªåŠ¨è½®æ¬¡ï¼Œå¢åŠ è½®æ•°è®¡æ•°
                    if (isAuto && !userChallenge) {
                        currentTurn++;
                    }
                    
                } catch (error) {
                    console.error('è¾©è®ºç”Ÿæˆå¤±è´¥:', error);
                    showError(`å‘è¨€å¤±è´¥ï¼š${error.message}`);
                } finally {
                    // è§£é”æŒ‰é’®
                    const totalSpeechCount = dialogueHistory.filter(d => d.speaker !== 'è£åˆ¤').length;
                    
                    if (totalSpeechCount < totalTurns * 2) {
                        continueBtn.disabled = false;
                    } else {
                         continueBtn.disabled = true;
                    }
                    
                    if (dialogueHistory.length > 0) {
                        userInput.disabled = false;
                        sendBtn.disabled = false;
                    }
                    
                    // å¦‚æœæ˜¯è‡ªåŠ¨è½®æ¬¡ï¼Œç»§ç»­è¿›è¡Œä¸‹ä¸€è½®ç›´åˆ°è½®æ•°ç»“æŸ
                    if (isAuto && totalSpeechCount < totalTurns * 2) {
                        // ç¨ä½œå»¶è¿Ÿï¼Œæ¨¡æ‹Ÿæ€è€ƒæ—¶é—´
                        setTimeout(() => {
                            generateNextTurn(true);
                        }, 3000); 
                    }
                }
            }

            // --- äº‹ä»¶ç›‘å¬å™¨ (ä¿æŒä¸å˜ï¼Œä½†é€»è¾‘ä¾èµ–æ–°çš„ generateNextTurn) ---

            // ç›‘å¬è½®æ¬¡é€‰æ‹©
            turnsSelect.addEventListener('change', (e) => {
                totalTurns = parseInt(e.target.value);
            });

            // å¯åŠ¨è¾©è®º
            startBtn.addEventListener('click', () => {
                const theme = themeInput.value.trim();
                if (!theme) {
                    showError('è¯·è¾“å…¥è¾©è®ºä¸»é¢˜ï¼');
                    return;
                }
                
                // é”å®šè®¾ç½®
                themeInput.disabled = true; // **é”å®šä¸­é—´åŒºåŸŸçš„ä¸»é¢˜è¾“å…¥æ¡†**
                turnsSelect.disabled = true;
                nameA.disabled = true;
                descA.disabled = true;
                personaA.disabled = true; // é”å®š
                nameB.disabled = true;
                descB.disabled = true;
                personaB.disabled = true; // é”å®š

                // åˆå§‹åŒ–çŠ¶æ€
                dialogueHistory = [];
                currentTurn = 0;
                currentSpeaker = 'A'; 
                chatHistory.innerHTML = '';
                
                // å¯åŠ¨ç¬¬ä¸€è½®
                generateNextTurn(true);
            });

            // è‡ªåŠ¨ç»§ç»­ä¸‹ä¸€è½®
            continueBtn.addEventListener('click', () => {
                generateNextTurn(true);
            });
            
            // ç”¨æˆ·ä»‹å…¥å¹¶å‘é€
            sendBtn.addEventListener('click', async () => {
                const challenge = userInput.value.trim();
                if (!challenge) return;

                // æ¸²æŸ“ç”¨æˆ·å‘è¨€ (ä½œä¸ºè£åˆ¤/ç¬¬ä¸‰æ–¹)
                renderMessage('è£åˆ¤', `ã€è£åˆ¤ä»‹å…¥ã€‘ï¼š${challenge}`);
                dialogueHistory.push({ speaker: 'è£åˆ¤', content: challenge });
                
                userInput.value = '';
                userInput.disabled = true;
                sendBtn.disabled = true;
                continueBtn.disabled = true;
                
                // è®©å½“å‰è½®åˆ°å‘è¨€çš„ Agent (currentSpeaker) é’ˆå¯¹ç”¨æˆ·çš„æŒ‘æˆ˜è¿›è¡Œå›åº”
                await generateNextTurn(false, challenge); 
                
                // å†æ¬¡è®©ä¸‹ä¸€ä½ Agent é’ˆå¯¹ä¸Šä¸€ä½çš„å›åº”è¿›è¡Œåé©³ (ä¿æŒè‡ªåŠ¨è½®æ¢é€»è¾‘)
                await generateNextTurn(true); 
            });


            // é‡ç½®åœºæ™¯
            resetBtn.addEventListener('click', () => {
                // è§£é”è®¾ç½®
                themeInput.disabled = false; // **è§£é”ä¸­é—´åŒºåŸŸçš„ä¸»é¢˜è¾“å…¥æ¡†**
                turnsSelect.disabled = false;
                nameA.disabled = false;
                descA.disabled = false;
                personaA.disabled = false; // è§£é”
                nameB.disabled = false;
                descB.disabled = false;
                personaB.disabled = false; // è§£é”

                // æŒ‰é’®çŠ¶æ€
                startBtn.disabled = false;
                continueBtn.disabled = true;
                userInput.disabled = true;
                sendBtn.disabled = true;
                
                // æ¸…ç†ç•Œé¢
                chatHistory.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">è¯·åœ¨å·¦ä¾§è®¾å®šäººç‰©ï¼Œè®¾å®šä¸»é¢˜ï¼Œç„¶ååœ¨å³ä¾§ç‚¹å‡»â€œå¼€å§‹è¾©è®ºâ€ï¼</p>';
                dialogueHistory = [];
                currentTurn = 0;
                currentSpeaker = 'A';
                userInput.value = '';
                showError('');
            });
        });
    </script>
</body>
</html>
